version: '3.8'

services:
  ic2-cloud-manager:
    # This will be replaced with your GitLab registry path
    # Format: registry.gitlab.com/username/project-name:latest
    image: ${GITLAB_REGISTRY_IMAGE:-ic2-cloud-manager:latest}
    container_name: peplink-ic2-manager
    environment:
      # Peplink API Configuration
      - PEPLINK_CLIENT_ID=${PEPLINK_CLIENT_ID:-1c7314d2ecc9c04138e5c7f0d1b538c9}
      - PEPLINK_CLIENT_SECRET=${PEPLINK_CLIENT_SECRET:-75fb1e2a82fa9ef06380a760d8b96b0e}
      - PEPLINK_API_URL=${PEPLINK_API_URL:-https://api.ic.peplink.com}

      # Application Configuration
      - PORT=8000

      # SSO Configuration (disabled for now)
      - SSO_ENABLED=false

      # User Authentication (format: username1:password1,username2:password2)
      # Leave empty to use default credentials (alex:hyrox)
      - PEPLINK_USERS=${PEPLINK_USERS:-}

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Traefik labels for SSL
    labels:
      - "traefik.enable=true"
      # HTTP Router (redirects to HTTPS)
      - "traefik.http.routers.ic2-http.rule=Host(`ic2.144.202.49.82.nip.io`)"
      - "traefik.http.routers.ic2-http.entrypoints=web"
      - "traefik.http.routers.ic2-http.middlewares=https-redirect"
      # HTTPS Router (NO SSO)
      - "traefik.http.routers.ic2.rule=Host(`ic2.144.202.49.82.nip.io`)"
      - "traefik.http.routers.ic2.entrypoints=websecure"
      - "traefik.http.routers.ic2.tls=true"
      - "traefik.http.services.ic2.loadbalancer.server.port=8000"

    networks:
      - sso_sso_network

networks:
  sso_sso_network:
    external: true
